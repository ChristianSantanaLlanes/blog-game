---
import Layout from '../layouts/Layout.astro';
import PostCard from '../components/PostCard.astro';
import HeroGrid from '../components/HeroGrid.astro';
import Newsletter from '../components/Newsletter.astro';
import Sidebar from '../components/Sidebar.astro';
import TrendingWidget from '../components/TrendingWidget.astro';
import CategoryCloud from '../components/CategoryCloud.astro';
import { getCollection } from 'astro:content';

const allNews = await getCollection('news');
const allGuides = await getCollection('guides');
const allTutorials = await getCollection('tutorials');

// Helper to format posts
const formatPost = (post, type, badge) => ({
	...post.data,
	slug: post.slug,
	type,
	badge: badge || post.data.badge
});

// Prepare data
const newsPosts = allNews.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()).map(p => formatPost(p, 'news', 'Noticia'));
const guidePosts = allGuides.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()).map(p => formatPost(p, 'guides', p.data.game || 'Guía'));
const tutorialPosts = allTutorials.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()).map(p => formatPost(p, 'tutorials', p.data.level));

// Hero Content (Last 3 items mixed or curated)
const heroItems = [...newsPosts, ...guidePosts, ...tutorialPosts].slice(0, 3);
const mainHero = heroItems[0];
const sideHero = heroItems.slice(1, 3);

// Filter out hero items from the rest to prevent duplicate transition names
const heroIds = new Set(heroItems.map(p => `${p.type}/${p.slug}`));
const isNotInHero = (p) => !heroIds.has(`${p.type}/${p.slug}`);

const displayNews = newsPosts.filter(isNotInHero).slice(0, 5);
const displayGuides = guidePosts.filter(isNotInHero).slice(0, 4);
const displayTutorials = tutorialPosts.filter(isNotInHero).slice(0, 4);

// Simulate Trending (mix of types)
const trendingPosts = [...displayNews, ...displayGuides].sort(() => 0.5 - Math.random()).slice(0, 5);
---

<Layout title="Inicio">
	<HeroGrid mainPost={mainHero} sidePosts={sideHero} />

	<div class="main-layout">
		<!-- Main Content Column -->
		<div class="main-content">
			<section class="section">
				<div class="section-header">
					<h2>Últimas <span class="text-primary">Noticias</span></h2>
					<a href="/news" class="view-all">Ver todas</a>
				</div>
				<div class="list-layout">
					{displayNews.map((post, index) => (
						<PostCard 
							title={post.title}
							description={post.description}
							date={post.date}
							image={post.image}
							href={`/news/${post.slug}`}
							badge={post.badge}
							variant="horizontal"
							loading={index === 0 ? "eager" : "lazy"}
						/>
					))}
				</div>
			</section>

			<section class="section mt-12">
				<div class="section-header">
					<h2>Guías <span class="text-secondary">Destacadas</span></h2>
					<a href="/guides" class="view-all">Ver todas</a>
				</div>
				<div class="grid-2col">
					{displayGuides.map(post => (
						<PostCard 
							title={post.title}
							description={post.description}
							date={post.date}
							image={post.image}
							href={`/guides/${post.slug}`}
							badge={post.badge}
						/>
					))}
				</div>
			</section>

			<section class="section mt-12">
				<div class="section-header">
					<h2>Aprende con <span class="text-accent">Tutoriales</span></h2>
					<a href="/tutorials" class="view-all">Ver todos</a>
				</div>
				<div class="grid-2col">
					{displayTutorials.map(post => (
						<PostCard 
							title={post.title}
							description={post.description}
							date={post.date}
							image={post.image}
							href={`/tutorials/${post.slug}`}
							badge={post.badge}
						/>
					))}
				</div>
			</section>
		</div>

		<!-- Sidebar Column -->
		<Sidebar>
			<TrendingWidget posts={trendingPosts} />
			<CategoryCloud />
			<Newsletter />
		</Sidebar>
	</div>
</Layout>

<style>
	.main-layout {
		display: grid;
		gap: 3rem;
	}

	@media (min-width: 1024px) {
		.main-layout {
			grid-template-columns: 1fr 340px;
		}
	}

	.section {
		margin-bottom: 4rem;
	}
	
	.mt-12 {
		margin-top: 3rem;
	}

	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-end;
		margin-bottom: 2rem;
		border-bottom: 1px solid #333;
		padding-bottom: 1rem;
	}

	h2 {
		font-size: 2rem;
		line-height: 1;
	}

	.text-primary { color: var(--color-primary); }
	.text-secondary { color: var(--color-secondary); }
	.text-accent { color: var(--color-accent); }

	.view-all {
		color: #888;
		font-size: 0.9rem;
		font-weight: 700;
		text-transform: uppercase;
		text-decoration: none;
		transition: color 0.2s;
	}
	
	.view-all:hover {
		color: #fff;
	}

	.list-layout {
		display: grid;
		gap: 2rem;
	}

	.grid-2col {
		display: grid;
		gap: 2rem;
		grid-template-columns: 1fr;
	}

	@media (min-width: 640px) {
		.grid-2col {
			grid-template-columns: repeat(2, 1fr);
		}
	}
</style>
